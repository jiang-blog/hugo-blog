---
tags: []
categories: ["work", "openvino_pot"]
description:
summary:
draft: false
isCJKLanguage: true
date: "2022-05-26"
lastmod: "2022-06-10"
title: 1-1-1-默认量化算法
---

# 1-1-1-默认量化算法

## 简介

DefaultQuantization算法被设计用来进行快速量化，而且在很多情况下是准确的。它没有任何精度指标的控制，但提供了很多可以用来改善精度的旋钮。

## 参数

DefaultQuantization算法有强制性和可选性参数。关于如何使用这些参数的更多细节，请参考[量化最佳实践](1-3_量化最佳实践.md)文件。下面是一个定义DefualtQuantization方法及其参数的例子：

```python
{
    "name": "DefaultQuantization", # the name of optimization algorithm
    "params": {
        ...
    }
}
```

### 强制性参数

- `"preset"` - 控制量化模式（对称和非对称）的预置。它可以取两个值。
  - `"performance"`（默认）--代表权重和激活的对称量化。这是在所有HW中性能最好的。
  - `"mixed"` - 权重的对称量化和激活的非对称量化。这种模式对于在量化操作中既有负输入值又有正输入值的NN的量化很有用，例如，基于非ReLU的CNN。

- `"stat_subset_size"`--计算用于量化的激活统计的子集的大小。如果没有指定参数，则使用整个数据集。我们建议使用不少于300个样本。

### 可选参数

所有其他选项可以被视为高级模式，需要对量化过程有深入的了解。下面是对所有可能的参数的总体描述。

- `"model type"` - 一个可选的参数，在模型中需要额外的模式，默认值是无（现在只支持 `"Transformer"`）。

- `"inplace_statistic"` - 一个可选的参数，需要改变方法收集统计数据，减少消耗的内存量，但增加校准时间

>[OpenVINO该如何量化yolov5模型?](https://www.zhihu.com/question/471868421/answer/2370765635)
- `"ignored"` - 应该从优化过程中排除的NN个子图
  - `"scope"` - 要排除的特定节点的列表
  - `"operations"` - 要排除的操作类型的列表（用OpenVINO IR符号表示）。这个列表由以下图元组成。
    - `"type"` - 忽略的操作类型
    - `"attributes"` - 如果定义了属性，它们将在忽略期间被考虑。它们由一个`"<NAME>"`的字典定义。`"<VALUE>"`对。

- `"weights"` - 本节手动定义了权重的量化方案和估计量化范围的方法。值得注意的是，改变量化方案可能导致无法在现有的HW上推断这种模式。
  - `"bits"` - 位宽，默认为8
  - `"mode"` - 量化模式(对称或不对称)
  - `"level_low"` - 我们量化的整数范围内的最小级别，无符号范围默认为0，有符号为-2^(bit-1)
  - `"level_high"` - 量化到的整数范围内的最大电平，无符号范围默认为2^bits-1，有符号为2^(bit-1)-1。
  - `"granularity"` - 量化尺度的颗粒度，可以取以下两个值。
    - `"pertensor"` (默认) - 每个张量的量化，有一个比例因子和零点
    - `"perchannel"` - 每个通道的量化，有每个通道的比例因子和零点
  - `"range_estimator"` - 这部分描述了范围估计器的参数，它被用于MinMaxQuantization方法中，以获得量化范围，并根据收集的统计数据过滤异常值。这些是用户可以改变的参数，以获得更好的精度结果。
    - `"max"`--用于估计量化浮点范围上边界的参数。
      - `"type"` - 估算器的类型。
        - `"max"`（默认）--估计量化值集合中的最大值
        - `"quantile"` - 估计量化值集合中的四分位数
      - `"outlier_prob"` - 在 `"quantile"`估计器中使用的outlier概率
    - `"min"` - 估算量化浮点范围的底线的参数。
      - `"type"` - 估算器的类型。
        - `"min"`（默认）--估计量化值集合中的最小值
        - `"quantile"` - 估计量化值集合中的quantile。
      - `"outlier_prob"` - 在 `"quantile "`估计器中使用的离群概率

- `"activations"` - 本节手动定义了激活的量化方案和估计量化范围的方法。同样，改变量化方案可能导致无法在现有的HW上推断出这种模式。
  - `"bits"` - 位宽，默认为8
  - `"mode"` - 量化模式(对称或不对称)
  - `"level_low"` - 我们量化的整数范围内的最小级别，无符号范围默认为0，有符号为-2^(bit-1)
  - "level_high“ - 量化到的整数范围内的最大电平，无符号范围默认为2^bits-1，有符号为2^(bit-1)-1。
  - `"granularity"` - 量化尺度的颗粒度，可以取以下两个值。
    - `"pertensor"` (默认) - 每个张量的量化，有一个比例因子和零点
    - `"perchannel"` - 每个通道的量化，有每个通道的比例因子和零点
  - `"range_estimator"` - 这部分描述了范围估计器的参数，它被用于MinMaxQuantization方法中，以获得量化范围，并根据收集的统计数据过滤异常值。这些是用户可以改变的参数，以获得更好的精度结果。
    - `"preset"` - 预设，为量化浮点范围的上边界和下边界定义相同的估算器。可能的值是 `"quantile"`。
    - `"max"` - 估计量化浮点范围上边界的参数。
      - `"aggregator"`--用估计器对校准数据集进行统计的函数类型，以得到上边界的值。
        - `"mean"`（默认）--集合的平均值
        - `"max"` - 集合的最大值
        - `"min"` - 集合的最小值
        - `"median"` - 集合的中位数值
        - `"mean_no_outliers"`--去除极端量值后的集合均值
        - `"median_no_outliers"` - 去除极端量值后的集合中值
        - `"hl_estimator"` - 基于Hodges-Lehmann过滤器的聚合器
      - `"type"` - 估计器的类型
        - `"max"`（默认）--估计量化值集合中的最大值
        - `"quantile"` - 估计量化值集合中的quantile。
      - `"outlier_prob"` - 在 `"quantile "`估计器中使用的outlier概率
    - `"min"` - 估算量化浮点范围的底线的参数。
      - `"type"` - 估算器的类型。
        - `"max"`（默认）--估计量化值集合中的最大值
        - `"quantile"` - 估计量化值集合中的四分位数
      - `"outlier_prob"` - 在 `"quantile "`估计器中使用的离群概率

- `"use_layerwise_tuning"` - 通过最小化原始和量化层输出之间的平均平方误差，实现对模型参数（偏置、卷积/MatMul权重和FakeQuantize尺度）的逐层微调。启用这个选项可以提高压缩模型的精度，但会导致执行时间和内存消耗的增加。

## 实例

教程：

- 图像分类模型的量化

- 模型动物园的物体检测模型的量化

- 医学数据分割模型的量化

- 文本分类中BERT的量化

示例：

- 三维分割模型的量化

- 人脸检测模型的量化

- 用于GNA设备的语音模型的量化

命令行示例：

- 图像分类模型的量化

用于POT命令行界面的默认量化算法的模板和完整规范：

- 模板

- 完整的规格
